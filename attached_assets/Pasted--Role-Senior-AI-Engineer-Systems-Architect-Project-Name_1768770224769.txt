# Role: Senior AI Engineer & Systems Architect
**Project Name:** Nabd (Pulse)
**Goal:** Build a production-ready MVP for an autonomous AI agent similar to "Manus AI" using Python.

# 1. Technical Stack Requirements
- **Language:** Python 3.10+
- **Backend Framework:** FastAPI (Async)
- **Agent Framework:** LangGraph (StateGraph architecture)
- **LLM Orchestration:** LangChain
- **Model:** OpenAI GPT-4o (via LangChain ChatOpenAI)
- **Search Tool:** Tavily Search API
- **Data Validation:** Pydantic v2

# 2. Architecture Overview
We need a "State Machine" based agent that operates in a loop:
`Planner` -> `Executor` -> `Reviewer` -> `Final Output`

**The Agent State (`AgentState`) must track:**
- `messages`: List of chat history.
- `plan`: List[str] (The steps generated by the planner).
- `current_step`: str (What is happening now).
- `tools_output`: dict (Data gathered from tools).
- `final_report`: str (The generated answer).

# 3. Core Components to Implement

## A. The Graph Nodes (`nodes.py`)
1.  **Planner Node:** Receives the user query, breaks it down into actionable steps (e.g., "Search for X", "Analyze Y", "Write Report").
2.  **Executor Node:** Looks at the `current_step`. Decides which tool to use (Search, Calculator, File Writer). Executes the tool and updates the state.
3.  **Reviewer Node:** Checks if the `tools_output` is sufficient to answer the user's request. If yes, pass to Writer. If no, loop back to Executor with feedback.
4.  **Writer Node:** Compiles all data into a formatted Markdown/PDF report.

## B. The Tools (`tools.py`)
Implement these tools as LangChain `@tool` functions:
1.  `web_search(query: str)`: Uses Tavily to get real-time info.
2.  `file_writer(content: str, filename: str)`: Saves text to a local directory `./data`.
3.  `python_repl(code: str)`: A safe local Python executor for math/data processing.

## C. The API (`main.py`)
Expose a POST endpoint `/run` that:
- Accepts `{"prompt": "User task..."}`.
- Initializes the LangGraph.
- Runs the graph asynchronously.
- Returns the final result.

# 4. "Nabd" Persona & System Prompt
Inject this personality into the LLM context:
"You are Nabd (نبض), a high-performance autonomous agent. You do not just chat; you act. You are precise, fast, and results-oriented. Always plan before executing. If a tool fails, self-correct and retry."

# 5. Deliverables
Please write the complete, modular code structure:
1.  `app/agent/state.py` (State definition)
2.  `app/agent/graph.py` (The StateGraph logic)
3.  `app/tools/defined_tools.py` (The tools)
4.  `app/main.py` (FastAPI entry point)
5.  `requirements.txt`

**Constraint:** ensure the code is clean, typed, and handles errors gracefully. Use `langgraph.graph.StateGraph`.
